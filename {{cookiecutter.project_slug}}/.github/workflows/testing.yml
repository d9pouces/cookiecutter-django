name: Test d9pouces/globalsitechecker
on:
  push:
    branches:
    - master
jobs:
  unittests:
    name: Unittests Python ${{ matrix.python-version }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ['3.11']
    services:
      sql_database:
        image: postgres:alpine
        options: >-
          --health-cmd "pg_isready -U username -d database"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          POSTGRES_DB: database
          POSTGRES_USER: username
      redis_database:
        image: redis:alpine
        options: >-
          --health-cmd 'redis-cli ping'
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          REDIS_PASSWORD: ''
      minio_storage:
        image: minio/minio:latest
        env:
          MINIO_ACCESS_KEY: access-key
          MINIO_SECRET_KEY: secret-key
        options: >-
          --health-cmd 'curl -f http://localhost:9000/minio/health/live'
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      PYTHONHASHSEED: 28739944
      OBJC_DISABLE_INITIALIZE_FORK_SAFETY: yes
    steps:
    - uses: actions/checkout@v3
    - uses: xom9ikk/dotenv@v2
      with:
        path: tools/base.env
    - uses: xom9ikk/dotenv@v2
      with:
        path: tools/in-container.env
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - run: python3 -m pip install -U pip pytest poetry
    - run: poetry install --all-extras
    - run: poetry run python manage.py collectstatic --noinput
    - run: poetry run python manage.py migrate
    - run: poetry run pytest -s
